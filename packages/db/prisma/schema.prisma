generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Aircraft {
  tail      String @id
  serial    String?
  make      String?
  model     String?
  typeCode  String?
  year      Int?
  engine    String?
  seats     Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owners    AircraftOwner[]
  accidents Accident[]
  events    EventLive[]

  @@index([make])
  @@index([model])
  @@index([year])
}

model Owner {
  id       String @id @default(uuid())
  name     String @unique
  type     String?
  state    String?
  country  String?
  redacted Boolean?

  aircrafts AircraftOwner[]
}

model AircraftOwner {
  tail      String
  ownerId   String
  startDate DateTime?
  endDate   DateTime?

  aircraft Aircraft @relation(fields: [tail], references: [tail])
  owner    Owner    @relation(fields: [ownerId], references: [id])

  @@id([tail, ownerId])
}

model AdDirective {
  id            Int @id @default(autoincrement())
  makeModelKey  String
  ref           String @unique
  summary       String?
  effectiveDate DateTime?
  status        String? // OPEN, CLOSED, APPLICABLE
  severity      String? // HIGH, MEDIUM, LOW

  @@index([makeModelKey])
  @@index([status])
}

model Accident {
  id        Int @id @default(autoincrement())
  tail      String
  date      DateTime?
  severity  String?
  lat       Float?
  lon       Float?
  narrative String?
  injuries  Int?
  fatalities Int?
  phase     String? // TAKEOFF, CRUISE, LANDING, etc.

  aircraft Aircraft? @relation(fields: [tail], references: [tail])

  @@index([tail])
  @@index([date])
  @@index([severity])
}

model EventLive {
  id     Int @id @default(autoincrement())
  tail   String
  ts     DateTime
  lat    Float?
  lon    Float?
  alt    Float?
  src    String?
  speed  Float?
  heading Float?

  aircraft Aircraft? @relation(fields: [tail], references: [tail])

  @@unique([tail, ts])
  @@index([tail])
  @@index([ts])
}

model Airport {
  icao      String @id
  iata      String?
  name      String?
  lat       Float?
  lon       Float?
  elevation Int?
  timezone  String?

  weather   WeatherMetar[]

  @@index([iata])
}

model WeatherMetar {
  id     Int @id @default(autoincrement())
  icao   String
  ts     DateTime
  raw    String?
  parsed String? // Store as JSON string for SQLite compatibility

  airport Airport? @relation(fields: [icao], references: [icao])

  @@index([icao])
}
